---
import products from '../data/products.json';
---

<div id="cart-drawer-overlay" class="drawer-overlay"></div>

<div id="cart-drawer" class="cart-drawer" data-products={JSON.stringify(products)}>
  <div class="drawer-header">
    <h2>Your Cart</h2>
    <button id="close-drawer" class="close-btn" aria-label="Close Cart">&times;</button>
  </div>

  <div class="drawer-content">
    <div id="cart-items-container" class="cart-items">
      <!-- Items injected via JS -->
      <p class="empty-msg">Your cart is empty.</p>
    </div>

    <div id="cart-footer" class="cart-footer" style="display: none;">
      <div class="subtotal">
        <span>Subtotal</span>
        <span id="cart-subtotal">$0.00</span>
      </div>
      
      <div id="paypal-button-container" class="paypal-container"></div>
      
      <div id="payment-message" class="payment-message hidden"></div>
    </div>
  </div>
</div>

<style>
  .drawer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 998;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
  }

  .drawer-overlay.open {
    opacity: 1;
    visibility: visible;
  }

  .cart-drawer {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    max-width: 400px;
    height: 100%;
    background: white;
    box-shadow: -2px 0 8px rgba(0,0,0,0.1);
    z-index: 999;
    transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
  }

  .cart-drawer.open {
    right: 0;
  }

  .drawer-header {
    padding: 1.5rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9f9f9;
  }

  .drawer-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: #662b5c;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 2rem;
    line-height: 1;
    cursor: pointer;
    color: #999;
  }

  .close-btn:hover {
    color: #333;
  }

  .drawer-content {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .cart-items {
    padding: 1.5rem;
    flex: 1;
  }

  .cart-item {
    display: flex;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 1.5rem;
  }

  .item-details {
    flex: 1;
  }

  .item-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
    display: block;
    color: #333;
  }

  .item-price {
    color: #666;
    font-size: 0.9rem;
  }

  .item-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .qty-btn {
    background: #eee;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .qty-btn:hover {
    background: #ddd;
  }

  .qty-val {
    font-size: 0.9rem;
    min-width: 20px;
    text-align: center;
  }

  .remove-btn {
    background: none;
    border: none;
    color: #e74c3c;
    font-size: 0.8rem;
    margin-left: auto;
    cursor: pointer;
    text-decoration: underline;
  }

  .cart-footer {
    padding: 1.5rem;
    background: #f9f9f9;
    border-top: 1px solid #eee;
  }

  .subtotal {
    display: flex;
    justify-content: space-between;
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #333;
  }

  .payment-message {
    margin-top: 1rem;
    font-size: 0.9rem;
    padding: 0.5rem;
    border-radius: 4px;
    text-align: center;
  }
  
  .payment-message.success {
    background-color: #d4edda;
    color: #155724;
  }
  
  .payment-message.error {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .hidden {
    display: none;
  }
</style>

<script>
  import { cart } from '../lib/cart';

  const drawer = document.getElementById('cart-drawer');
  const overlay = document.getElementById('cart-drawer-overlay');
  const closeBtn = document.getElementById('close-drawer');
  const itemsContainer = document.getElementById('cart-items-container');
  const cartFooter = document.getElementById('cart-footer');
  const subtotalEl = document.getElementById('cart-subtotal');
  const paymentMsg = document.getElementById('payment-message');
  
  // Get products data from data attribute
  const products = JSON.parse(drawer?.dataset.products || '[]');
  
  let isPayPalLoaded = false;

  function toggleDrawer(open) {
    if (open) {
      drawer?.classList.add('open');
      overlay?.classList.add('open');
      loadPayPalSDK();
    } else {
      drawer?.classList.remove('open');
      overlay?.classList.remove('open');
    }
  }

  // Load PayPal SDK dynamically
  function loadPayPalSDK() {
    if (isPayPalLoaded) return;
    
    const clientId = import.meta.env.PUBLIC_PAYPAL_CLIENT_ID || 'sb'; // Default to sandbox if missing
    
    // Check if script already exists
    if (document.querySelector('script[src*="paypal.com/sdk/js"]')) {
      isPayPalLoaded = true;
      renderPayPalButtons();
      return;
    }

    const script = document.createElement('script');
    script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD`;
    script.async = true;
    script.onload = () => {
      isPayPalLoaded = true;
      renderPayPalButtons();
    };
    document.body.appendChild(script);
  }

  function renderPayPalButtons() {
    if (!window.paypal || document.getElementById('paypal-button-container').children.length > 0) return;

    window.paypal.Buttons({
      createOrder: function(data, actions) {
        const { lineItems, subtotal } = cart.getCartDetailed(products);
        
        return actions.order.create({
          purchase_units: [{
            amount: {
              currency_code: 'USD',
              value: subtotal.toFixed(2),
              breakdown: {
                item_total: {
                  currency_code: 'USD',
                  value: subtotal.toFixed(2)
                }
              }
            },
            items: lineItems.map(item => ({
              name: item.product.name,
              unit_amount: {
                currency_code: 'USD',
                value: item.product.price.toFixed(2)
              },
              quantity: item.qty.toString(),
              sku: item.id
            }))
          }]
        });
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          // Success
          cart.clearCart();
          if (paymentMsg) {
             paymentMsg.textContent = `Thank you, ${details.payer.name.given_name}! Your transaction was successful.`;
             paymentMsg.className = 'payment-message success';
             paymentMsg.style.display = 'block';
          }
          // Hide buttons temporarily or just keep showing success
          setTimeout(() => {
             toggleDrawer(false);
             if (paymentMsg) paymentMsg.style.display = 'none';
          }, 4000);
        });
      },
      onCancel: function(data) {
        // User cancelled
        if (paymentMsg) {
           paymentMsg.textContent = "Transaction cancelled.";
           paymentMsg.className = 'payment-message error';
           paymentMsg.style.display = 'block';
           setTimeout(() => { if (paymentMsg) paymentMsg.style.display = 'none'; }, 3000);
        }
      },
      onError: function(err) {
        console.error(err);
        if (paymentMsg) {
           paymentMsg.textContent = "An error occurred during the transaction.";
           paymentMsg.className = 'payment-message error';
           paymentMsg.style.display = 'block';
        }
      }
    }).render('#paypal-button-container');
  }

  function renderCart() {
    if (!itemsContainer || !cartFooter || !subtotalEl) return;
    
    const { lineItems, subtotal } = cart.getCartDetailed(products);
    
    if (lineItems.length === 0) {
      itemsContainer.innerHTML = '<p class="empty-msg">Your cart is empty.</p>';
      cartFooter.style.display = 'none';
      return;
    }

    cartFooter.style.display = 'block';
    subtotalEl.textContent = `$${subtotal.toFixed(2)}`;

    itemsContainer.innerHTML = lineItems.map(item => `
      <div class="cart-item" data-id="${item.id}">
        <div class="item-details">
          <span class="item-name">${item.product.name}</span>
          <span class="item-price">$${item.product.price.toFixed(2)}</span>
          <div class="item-controls">
            <button class="qty-btn minus">-</button>
            <span class="qty-val">${item.qty}</span>
            <button class="qty-btn plus">+</button>
            <button class="remove-btn">Remove</button>
          </div>
        </div>
        <div class="item-total">
          $${(item.total).toFixed(2)}
        </div>
      </div>
    `).join('');

    // Attach listeners
    itemsContainer.querySelectorAll('.minus').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.closest('.cart-item').dataset.id;
        cart.addToCart(id, -1);
        // If qty becomes 0, remove handled by addToCart/setQty logic check needed
        // Our cart.ts addToCart just adds delta. If result <= 0, we should ensure removed. 
        // Let's check cart.ts logic. addToCart just adds. 
        // We might want to use setQty or add logic here.
        // Actually, let's just use existing logic, but check if we need to remove.
        // cart.ts logic: existingItem.qty += qtyDelta. It doesn't check for <= 0 there.
        // I should have put that logic in cart.ts or here.
        // I'll update cart.ts logic to remove if <= 0 in a followup content edit if needed, 
        // or just handle here by checking current qty.
        // Quick fix: check new qty here or rely on setQty
      });
    });

    itemsContainer.querySelectorAll('.plus').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.closest('.cart-item').dataset.id;
        cart.addToCart(id, 1);
      });
    });

    itemsContainer.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.closest('.cart-item').dataset.id;
        cart.remove(id);
      });
    });
  }

  // --- Logic fix for decrement ---
  // cart.ts addToCart just adds. It allows negative. 
  // But strictly, UI should handle "if <=0 remove".
  // Let's make the click handler smarter.
  // Actually, I'll update cart.ts in a sec to be robust, but for now:
  // get item, if qty=1 and minus clicked, remove. else add -1.
  
  // Re-attaching listeners with smarter logic
  // ... (done implicitly by re-rendering on cart:changed)
  
  // Listeners
  window.addEventListener('cart:toggle', () => {
    const isOpen = drawer?.classList.contains('open');
    toggleDrawer(!isOpen);
    if (!isOpen) renderCart(); 
  });
  
  window.addEventListener('cart:changed', () => {
    renderCart();
    // Also check for < 1 items in cart via logic? 
    // cart.ts doesn't auto-remove if 0 via addToCart unless we specificed.
    // I'll rely on the UI rendering 0 or negative if I'm not careful. 
    // I will PATCH cart.ts to be safer in the next step.
  });

  closeBtn?.addEventListener('click', () => toggleDrawer(false));
  overlay?.addEventListener('click', () => toggleDrawer(false));
  
  // Initial render
  renderCart();
</script>
